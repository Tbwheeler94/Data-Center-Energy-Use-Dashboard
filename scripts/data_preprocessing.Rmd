---
title: "Data Center Energy Use Dashboard - Raw Collection Spreadsheet Preprocessing Steps"
author: "Tom Wheeler & Isaiah Garcia"
date: "5/6/2021"
output: html_document
---

################################## Read In Libraries ###########################################

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(janitor)
library(readxl)
library(xlsx)
library(lubridate)
library(ggiraph)
library(ggplot2)
library(fastDummies)
library(plotly)

```

#################################### SECTION 1 #################################################
########## Import 3 sheets of data from DataCenterEnergyUse-RawCollection.xlsx #################
################################################################################################

```{r}
#import "Input - Energy Use" sheet of DataCenterEnergyUse-RawCollection.xlsx spreadsheet
data_sheet_energy <- read.xlsx2(here('data',"DataCenterEnergyUse-RawCollection.xlsx"), 1, #the "1" specifies to import sheet 1
                         
                             #specify column data types to ensure proper recognition
                             colClasses=c("character","integer","Date","Date","character", #columns 1-5
                                          "character", "character","character","numeric","integer", #columns 6-10
                                          "character", "character","character","character","numeric", #columns 11-15 (Fuel 1)
                                          "integer", "character","character","character","numeric", #columns 15-20 (Fuel 2)
                                          "integer", "character","character","character","numeric", #columns 21-25 (Fuel 3)
                                          "integer", "character","character","character","numeric", #columns 26-30 (Fuel 4)
                                          "integer", "character","character","character","numeric", #columns 31-35 (Fuel 5)
                                          "integer", "character")) #column 36, 37 (Notes)

#move second row values to column headers, put header names in tidy format
data_sheet_energy <- data_sheet_energy %>% 
  row_to_names(1) %>% 
  clean_names()

#change column names that were set to incorrect values when column classes were set
colnames(data_sheet_energy) [2] <- 'report_year'
colnames(data_sheet_energy) [3] <- 'period_covered_start_date'
colnames(data_sheet_energy) [4] <- 'period_covered_end_date'
colnames(data_sheet_energy) [5] <- 'energy_reporting_scope'
colnames(data_sheet_energy) [6] <- 'level_of_ownership'
colnames(data_sheet_energy) [9] <- 'electricity_value'
colnames(data_sheet_energy) [10] <- 'unit_scale'
colnames(data_sheet_energy) [15] <- 'fuel_1_value'
colnames(data_sheet_energy) [16] <- 'fuel_1_unit_scale'
colnames(data_sheet_energy) [20] <- 'fuel_2_value'
colnames(data_sheet_energy) [21] <- 'fuel_2_unit_scale'
colnames(data_sheet_energy) [25] <- 'fuel_3_value'
colnames(data_sheet_energy) [26] <- 'fuel_3_unit_scale'
colnames(data_sheet_energy) [30] <- 'fuel_4_value'
colnames(data_sheet_energy) [31] <- 'fuel_4_unit_scale'
colnames(data_sheet_energy) [35] <- 'fuel_5_value'
colnames(data_sheet_energy) [36] <- 'fuel_5_unit_scale'

```

```{r}

#import "Input - Company Profiles" sheet of DataCenterEnergyUse-RawCollection.xlsx spreadsheet
data_sheet_company <- read.xlsx2(here('data',"DataCenterEnergyUse-RawCollection.xlsx"), 2, #the "2" specifies to import sheet 2
                         
                             #specify column data types to ensure proper recognition
                             colClasses=c("character","character","character","integer","Date", #columns 1-5
                                          "character","character","character","character","character", #columns 6-10
                                          "character","character","character","character","character", #columns 11-15
                                          "character","character","character","character","character", #columns 16-20
                                          "character","character","character","character","character", #columns 21-25
                                          "character","character","character","character","character", #columns 26-30
                                          "character","character","character","character","character", #columns 31-35
                                          "character","character","character","character")) #column 36-39

#move second row values to column headers, put header names in tidy format
data_sheet_company <- data_sheet_company %>% 
  row_to_names(2) %>% 
  clean_names() %>%
  select(!c(who_added_the_company, x, qts, x2019, x_2, x_3, x_4))

#change column names that were set to incorrect values when column classes were set
colnames(data_sheet_company) [3] <- 'company_founding_year'
colnames(data_sheet_company) [4] <- 'date_last_updated'

```

```{r}

#import "Input - PUE" sheet of DataCenterEnergyUse-RawCollection.xlsx spreadsheet
data_sheet_pue <- read.xlsx2(here('data',"DataCenterEnergyUse-RawCollection.xlsx"), 3, #the "3" specifies to import sheet 3
                         
                             #specify column data types to ensure proper recognition
                             colClasses=c("character","integer","character","character","character", #columns 1-5
                                          "numeric","character","character","character","character", #columns 6-10
                                          "character","character","character","character"))          #columns 11-14

#move second row values to column headers, put header names in tidy format
data_sheet_pue <- data_sheet_pue %>% 
  row_to_names(1) %>% 
  clean_names()

colnames(data_sheet_pue) [2] <- 'applicable_year'
colnames(data_sheet_pue) [6] <- 'pue_value'

```

########################################## SECTION 2 #######################################################
########## Transform data across multiple years in proportion to its Period Covered Start and End ##########
############################################################################################################

```{r}

###############################################################
########## Prepare values for transformation ##################
###############################################################

data_sheet_energy_scaled <- data_sheet_energy %>% 
  #calculate total number of reported days data is applicable to by subtracting the period covered start date from the end date (R recognizes date values as integers)
  mutate(year_total_reported_days = period_covered_end_date - period_covered_start_date, .after = period_covered_end_date) %>% 
  
  #extract the year from period_covered_end_date to create conditional for leap year
  mutate(period_covered_end_year = year(period_covered_end_date), .after = period_covered_end_date) %>%
  mutate(period_covered_start_year = year(period_covered_start_date), .after = period_covered_start_date) %>% 
  
  #convert year values into the number of in the start or end year data is reported
  mutate(period_covered_start_date_number = (365 - yday(period_covered_start_date)), .after = period_covered_start_date) %>% 
  mutate(period_covered_end_date_number = yday(period_covered_end_date), .after = period_covered_end_date) %>% 
  
  #convert dates to proportions
  mutate(period_covered_start_date_number = (period_covered_start_date_number/as.integer(year_total_reported_days))) %>% 
  mutate(period_covered_end_date_number = (period_covered_end_date_number/as.integer(year_total_reported_days))) %>% 
  
  #rename columns
  rename(period_start_proportion = period_covered_start_date_number) %>% 
  rename(period_end_proportion = period_covered_end_date_number)

#make 2 copies of dataframe, 1 for period 1 values, one for period 2 values
data_sheet_energy_scaled_period_1 <- data_sheet_energy_scaled
data_sheet_energy_scaled_period_2 <- data_sheet_energy_scaled

###############################################################
####### Transform values for period 1 in first sheet ##########
###############################################################

#created scaled values for period 2
data_sheet_energy_scaled_period_1$electricity_value_scaled_period <-
  
  #if start and end year are the same, multiply electricity value by 1, else, multiply by the proportion of days in the first year
  ifelse(data_sheet_energy_scaled_period_1$period_covered_start_year == 
         data_sheet_energy_scaled_period_1$period_covered_end_year, data_sheet_energy_scaled_period_1$electricity_value*1,
         data_sheet_energy_scaled_period_1$electricity_value*data_sheet_energy_scaled_period_1$period_start_proportion) 

data_sheet_energy_scaled_period_1$fuel_1_value_scaled_period <-
  
  #if start and end year are the same, multiply fuel 1 value by 1, else, multiply by the proportion of days in the first year
  ifelse(data_sheet_energy_scaled_period_1$period_covered_start_year == 
         data_sheet_energy_scaled_period_1$period_covered_end_year, data_sheet_energy_scaled_period_1$fuel_1_value*1,
         data_sheet_energy_scaled_period_1$fuel_1_value*data_sheet_energy_scaled_period_1$period_start_proportion)

data_sheet_energy_scaled_period_1$fuel_2_value_scaled_period <-
  
  #if start and end year are the same, multiply fuel 2 value by 2, else, multiply by the proportion of days in the first year
  ifelse(data_sheet_energy_scaled_period_1$period_covered_start_year == 
         data_sheet_energy_scaled_period_1$period_covered_end_year, data_sheet_energy_scaled_period_1$fuel_2_value*1,
         data_sheet_energy_scaled_period_1$fuel_2_value*data_sheet_energy_scaled_period_1$period_start_proportion)

data_sheet_energy_scaled_period_1$fuel_3_value_scaled_period <-
  
  #if start and end year are the same, multiply fuel 3 value by 3, else, multiply by the proportion of days in the first year
  ifelse(data_sheet_energy_scaled_period_1$period_covered_start_year == 
         data_sheet_energy_scaled_period_1$period_covered_end_year, data_sheet_energy_scaled_period_1$fuel_3_value*1,
         data_sheet_energy_scaled_period_1$fuel_3_value*data_sheet_energy_scaled_period_1$period_start_proportion)

data_sheet_energy_scaled_period_1$fuel_4_value_scaled_period <-
  
  #if start and end year are the same, multiply fuel 4 value by 4, else, multiply by the proportion of days in the first year
  ifelse(data_sheet_energy_scaled_period_1$period_covered_start_year == 
         data_sheet_energy_scaled_period_1$period_covered_end_year, data_sheet_energy_scaled_period_1$fuel_4_value*1,
         data_sheet_energy_scaled_period_1$fuel_4_value*data_sheet_energy_scaled_period_1$period_start_proportion)

data_sheet_energy_scaled_period_1$fuel_5_value_scaled_period <-
  
  #if start and end year are the same, multiply fuel 5 value by 5, else, multiply by the proportion of days in the first year
  ifelse(data_sheet_energy_scaled_period_1$period_covered_start_year == 
         data_sheet_energy_scaled_period_1$period_covered_end_year, data_sheet_energy_scaled_period_1$fuel_5_value*1,
         data_sheet_energy_scaled_period_1$fuel_5_value*data_sheet_energy_scaled_period_1$period_start_proportion)

#shift all scaled columns to earlier columns in the spreadsheet for easier viewing
data_sheet_energy_scaled_period_1 <- data_sheet_energy_scaled_period_1 %>% 
  relocate(electricity_value_scaled_period, .after = electricity_value) %>% 
  relocate(fuel_1_value_scaled_period, .after = fuel_1_value) %>% 
  relocate(fuel_2_value_scaled_period, .after = fuel_2_value) %>%
  relocate(fuel_3_value_scaled_period, .after = fuel_3_value) %>%
  relocate(fuel_4_value_scaled_period, .after = fuel_4_value) %>%
  relocate(fuel_5_value_scaled_period, .after = fuel_5_value) %>% 
  
  #save only start date, end date, and data year (year data applies to) by removing the following columns
  select(!c(period_start_proportion, period_covered_end_year, period_end_proportion, year_total_reported_days)) %>% 
  rename(data_year = period_covered_start_year)

###############################################################
####### Transform values for period 2 in second sheet #########
###############################################################

#created scaled values for period 2
data_sheet_energy_scaled_period_2$electricity_value_scaled_period <-
  
  #if start and end year are the same, multiply electricity value by 1, else, multiply by the proportion of days in the first year
  ifelse(data_sheet_energy_scaled_period_2$period_covered_start_year == 
         data_sheet_energy_scaled_period_2$period_covered_end_year, data_sheet_energy_scaled_period_2$electricity_value*1,
         data_sheet_energy_scaled_period_2$electricity_value*data_sheet_energy_scaled_period_2$period_end_proportion) 

data_sheet_energy_scaled_period_2$fuel_1_value_scaled_period <-
  
  #if start and end year are the same, multiply fuel 1 value by 1, else, multiply by the proportion of days in the first year
  ifelse(data_sheet_energy_scaled_period_2$period_covered_start_year == 
         data_sheet_energy_scaled_period_2$period_covered_end_year, data_sheet_energy_scaled_period_2$fuel_1_value*1,
         data_sheet_energy_scaled_period_2$fuel_1_value*data_sheet_energy_scaled_period_2$period_end_proportion)

data_sheet_energy_scaled_period_2$fuel_2_value_scaled_period <-
  
  #if start and end year are the same, multiply fuel 1 value by 1, else, multiply by the proportion of days in the first year
  ifelse(data_sheet_energy_scaled_period_2$period_covered_start_year == 
         data_sheet_energy_scaled_period_2$period_covered_end_year, data_sheet_energy_scaled_period_2$fuel_2_value*1,
         data_sheet_energy_scaled_period_2$fuel_2_value*data_sheet_energy_scaled_period_2$period_end_proportion)

data_sheet_energy_scaled_period_2$fuel_3_value_scaled_period <-
  
  #if start and end year are the same, multiply fuel 1 value by 1, else, multiply by the proportion of days in the first year
  ifelse(data_sheet_energy_scaled_period_2$period_covered_start_year == 
         data_sheet_energy_scaled_period_2$period_covered_end_year, data_sheet_energy_scaled_period_2$fuel_3_value*1,
         data_sheet_energy_scaled_period_2$fuel_3_value*data_sheet_energy_scaled_period_2$period_end_proportion)

data_sheet_energy_scaled_period_2$fuel_4_value_scaled_period <-
  
  #if start and end year are the same, multiply fuel 1 value by 1, else, multiply by the proportion of days in the first year
  ifelse(data_sheet_energy_scaled_period_2$period_covered_start_year == 
         data_sheet_energy_scaled_period_2$period_covered_end_year, data_sheet_energy_scaled_period_2$fuel_4_value*1,
         data_sheet_energy_scaled_period_2$fuel_4_value*data_sheet_energy_scaled_period_2$period_end_proportion)

data_sheet_energy_scaled_period_2$fuel_5_value_scaled_period <-
  
  #if start and end year are the same, multiply fuel 1 value by 1, else, multiply by the proportion of days in the first year
  ifelse(data_sheet_energy_scaled_period_2$period_covered_start_year == 
         data_sheet_energy_scaled_period_2$period_covered_end_year, data_sheet_energy_scaled_period_2$fuel_5_value*1,
         data_sheet_energy_scaled_period_2$fuel_5_value*data_sheet_energy_scaled_period_2$period_end_proportion)

#drop all values where period covered start and end are equal prior to rbinding to the period 1 dataframe
data_sheet_energy_scaled_period_2 <- subset(data_sheet_energy_scaled_period_2, period_covered_start_year != period_covered_end_year) 

#relocate scaled column values to align with period 1 values
data_sheet_energy_scaled_period_2 <- data_sheet_energy_scaled_period_2 %>% 
  relocate(electricity_value_scaled_period, .after = electricity_value) %>% 
  relocate(fuel_1_value_scaled_period, .after = fuel_1_value) %>% 
  relocate(fuel_2_value_scaled_period, .after = fuel_2_value) %>%
  relocate(fuel_3_value_scaled_period, .after = fuel_3_value) %>%
  relocate(fuel_4_value_scaled_period, .after = fuel_4_value) %>%
  relocate(fuel_5_value_scaled_period, .after = fuel_5_value) %>% 
  
  #save only start date, end date, and data year (year data applies to) by removing the following columns
  select(!c(period_start_proportion, period_covered_start_year, period_end_proportion, year_total_reported_days)) %>% 
  rename(data_year = period_covered_end_year)

###############################################################
####### Combine spreadsheets together and combine years #######
###############################################################

data_sheet_energy_scaled_combined <- rbind(data_sheet_energy_scaled_period_1, data_sheet_energy_scaled_period_2) %>%
  
  #drop original raw values from spreadsheet
  select(!c(electricity_value, fuel_1_value, fuel_2_value, fuel_3_value, fuel_4_value, fuel_5_value)) %>% 
  
  #rename scaled columns to be original raw value names
  rename(electricity_value = electricity_value_scaled_period) %>% 
  rename(fuel_1_value = fuel_1_value_scaled_period) %>% 
  rename(fuel_2_value = fuel_2_value_scaled_period) %>% 
  rename(fuel_3_value = fuel_3_value_scaled_period) %>% 
  rename(fuel_4_value = fuel_4_value_scaled_period) %>% 
  rename(fuel_5_value = fuel_5_value_scaled_period) %>% 
  
  #rename columns
  relocate(electricity_value, .after = notes) %>% 
  relocate(fuel_1_value, .after = fuel_1_type) %>% 
  relocate(fuel_2_value, .after = fuel_2_type) %>%
  relocate(fuel_3_value, .after = fuel_3_type) %>%
  relocate(fuel_4_value, .after = fuel_4_type) %>%
  relocate(fuel_5_value, .after = fuel_5_type)

```

########################################## SECTION 3 #######################################################
####### Multiply all data by respective unit scale and conversion unit to transform all values to kWh ######
############################################################################################################

```{r}

###########################################################################################
## Multiply values by unit scale to generate values that are ready for unit conversion ####
###########################################################################################

data_sheet_energy <- data_sheet_energy_scaled_combined %>% 
  
  #replace any unit_scale NA values with 1
  mutate(unit_scale = replace_na(unit_scale, 1)) %>%
  mutate(fuel_1_unit_scale = replace_na(fuel_1_unit_scale, 1)) %>%
  mutate(fuel_2_unit_scale = replace_na(fuel_2_unit_scale, 1)) %>%
  mutate(fuel_3_unit_scale = replace_na(fuel_3_unit_scale, 1)) %>%
  mutate(fuel_4_unit_scale = replace_na(fuel_4_unit_scale, 1)) %>%
  mutate(fuel_5_unit_scale = replace_na(fuel_5_unit_scale, 1)) %>%
  
  #multiply electricity and fuel values by unit scale
  mutate(electricity_prepped = electricity_value * unit_scale, .after = unit_scale) %>% 
  mutate(fuel_1_prepped = fuel_1_value * fuel_1_unit_scale, .after = fuel_1_unit_scale) %>% 
  mutate(fuel_2_prepped = fuel_2_value * fuel_2_unit_scale, .after = fuel_2_unit_scale) %>% 
  mutate(fuel_3_prepped = fuel_3_value * fuel_3_unit_scale, .after = fuel_3_unit_scale) %>% 
  mutate(fuel_4_prepped = fuel_4_value * fuel_4_unit_scale, .after = fuel_4_unit_scale) %>% 
  mutate(fuel_5_prepped = fuel_5_value * fuel_5_unit_scale, .after = fuel_5_unit_scale)

data_sheet_energy <- data_sheet_energy %>% 
  
  #merge fuel type and units to prepare for vlookup function
  unite(fuel_unit_1, c(fuel_1_type, fuel_1_unit), sep = " ", remove = FALSE) %>% 
  unite(fuel_unit_2, c(fuel_2_type, fuel_2_unit), sep = " ", remove = FALSE) %>% 
  unite(fuel_unit_3, c(fuel_3_type, fuel_3_unit), sep = " ", remove = FALSE) %>% 
  unite(fuel_unit_4, c(fuel_4_type, fuel_4_unit), sep = " ", remove = FALSE) %>% 
  unite(fuel_unit_5, c(fuel_5_type, fuel_5_unit), sep = " ", remove = FALSE)

```

```{r}

#################################################################################################
####### Calculate energy unit conversions to base unit (kWh) and add to data_sheet_energy #######
#################################################################################################

#import conversions spreadsheet, select columns data types, clean header names, select columns, unite fuel and unit columns
conversions_sheet <- read.xlsx2(here('data',"DataCenterEnergyUse-RawCollection.xlsx"), 6,
                                colClasses=c("character", "character", "character", "numeric")) %>% 
                                clean_names() %>% 
                                select('fuel', 'unit', 'k_wh_1_unit') %>% 
                                drop_na() %>% 
                                unite('fuel_unit', fuel:unit, sep = " ", remove = FALSE)

######################################
#calculate conversion for electricity#
######################################

#isolate electricity values and respective units into dataframe
electricity_data <- data_sheet_energy %>% 
  select('electricity_prepped', 'unit') %>% 
  relocate(electricity_prepped, .after = unit)

#select just unit column and the relevant conversion because electricity values do not have an associated fuel
conversions_sheet_electricity <- conversions_sheet %>%
  select('unit', 'k_wh_1_unit') %>% 
  distinct()

#join and match unit conversion factor for electricity values (i.e. if MWh value should be multiplied by 1000)
electricity_conversion <- left_join(electricity_data, conversions_sheet_electricity, by="unit") %>% 
  mutate(electricity_converted = electricity_prepped * k_wh_1_unit)

#################################
#calculate conversions for fuels#
#################################

#FUEL 1

#isolate fuel unit and prepped values into dataframe
fuel_1_data <- data_sheet_energy %>% 
  select('fuel_unit_1', 'fuel_1_prepped')

#change name of left column from conversion sheet to match fuel number
conversions_sheet_fuel_1 <- conversions_sheet %>%
  select('fuel_unit', 'k_wh_1_unit') %>% 
  rename(fuel_unit_1 = fuel_unit)

#join and match, calculate prepped fuel value multiplied by its respective conversion
fuel_1_conversion <- left_join(fuel_1_data, conversions_sheet_fuel_1, by="fuel_unit_1") %>% 
  mutate(fuel_1_converted = fuel_1_prepped * k_wh_1_unit)

#FUEL 2

#isolate fuel unit and prepped values into dataframe
fuel_2_data <- data_sheet_energy %>% 
  select('fuel_unit_2', 'fuel_2_prepped')

#change name of left column from conversion sheet to match fuel number
conversions_sheet_fuel_2 <- conversions_sheet %>%
  select('fuel_unit', 'k_wh_1_unit') %>% 
  rename(fuel_unit_2 = fuel_unit)

#join and match, calculate prepped fuel value multiplied by its respective conversion
fuel_2_conversion <- left_join(fuel_2_data, conversions_sheet_fuel_2, by="fuel_unit_2") %>% 
  mutate(fuel_2_converted = fuel_2_prepped * k_wh_1_unit)

#FUEL 3

#isolate fuel unit and prepped values into dataframe
fuel_3_data <- data_sheet_energy %>% 
  select('fuel_unit_3', 'fuel_3_prepped')

#change name of left column from conversion sheet to match fuel number
conversions_sheet_fuel_3 <- conversions_sheet %>% 
  select('fuel_unit', 'k_wh_1_unit') %>% 
  rename(fuel_unit_3 = fuel_unit)

#join and match, calculate prepped fuel value multiplied by its respective conversion
fuel_3_conversion <- left_join(fuel_3_data, conversions_sheet_fuel_3, by="fuel_unit_3") %>% 
  mutate(fuel_3_converted = fuel_3_prepped * k_wh_1_unit)

#FUEL 4

#isolate fuel unit and prepped values into dataframe
fuel_4_data <- data_sheet_energy %>% 
  select('fuel_unit_4', 'fuel_4_prepped')

#change name of left column from conversion sheet to match fuel number
conversions_sheet_fuel_4 <- conversions_sheet %>%
  select('fuel_unit', 'k_wh_1_unit') %>% 
  rename(fuel_unit_4 = fuel_unit)

#join and match, calculate prepped fuel value multiplied by its respective conversion
fuel_4_conversion <- left_join(fuel_4_data, conversions_sheet_fuel_4, by="fuel_unit_4") %>% 
  mutate(fuel_4_converted = fuel_4_prepped * k_wh_1_unit)

#FUEL 5

#isolate fuel unit and prepped values into dataframe
fuel_5_data <- data_sheet_energy %>% 
  select('fuel_unit_5', 'fuel_5_prepped')

#change name of left column from conversion sheet to match fuel number
conversions_sheet_fuel_5 <- conversions_sheet %>% 
  select('fuel_unit', 'k_wh_1_unit') %>% 
  rename(fuel_unit_5 = fuel_unit)

#join and match, calculate prepped fuel value multiplied by its respective conversion
fuel_5_conversion <- left_join(fuel_5_data, conversions_sheet_fuel_5, by="fuel_unit_5") %>% 
  mutate(fuel_5_converted = fuel_5_prepped * k_wh_1_unit)

#Bind converted values to data_sheet_energy, move columns next to fuel_1_prepped for easier viewing
data_sheet_energy <- cbind(data_sheet_energy, electricity_conversion["electricity_converted"],
                    fuel_1_conversion["fuel_1_converted"], 
                    fuel_2_conversion["fuel_2_converted"],
                    fuel_3_conversion["fuel_3_converted"],
                    fuel_4_conversion["fuel_4_converted"],
                    fuel_5_conversion["fuel_5_converted"]) %>% 
              relocate(fuel_1_converted, .after = fuel_1_prepped) %>% 
              relocate(fuel_2_converted, .after = fuel_2_prepped) %>%
              relocate(fuel_3_converted, .after = fuel_3_prepped) %>%
              relocate(fuel_4_converted, .after = fuel_4_prepped) %>%
              relocate(fuel_5_converted, .after = fuel_5_prepped)
```

```{r}
#####################################################################################################
####### Merge fuel converted values into a separate spreadsheet to prepare for graphing #############
#####################################################################################################

#isolate electricity values
data_sheet_energy_electricity <- data_sheet_energy %>% 
  select("company", "data_year", "electricity_converted") %>% 
  add_column(fuel_type = "Electricity") %>% 
  relocate("fuel_type", .after = data_year) %>% 
  rename(value = electricity_converted)

#isolate fuel 1 values
data_sheet_energy_combined_1 <- data_sheet_energy %>% 
  select("company", "data_year", "fuel_1_type", "fuel_1_converted") %>% 
  rename(fuel_type = fuel_1_type) %>% 
  rename(value = fuel_1_converted)

#isolate fuel 2 values
data_sheet_energy_combined_2 <- data_sheet_energy %>% 
  select("company", "data_year", "fuel_2_type", "fuel_2_converted") %>% 
  rename(fuel_type = fuel_2_type) %>% 
  rename(value = fuel_2_converted)

#isolate fuel 3 values
data_sheet_energy_combined_3 <- data_sheet_energy %>% 
  select("company", "data_year", "fuel_3_type", "fuel_3_converted") %>% 
  rename(fuel_type = fuel_3_type) %>% 
  rename(value = fuel_3_converted)

#isolate fuel 4 values
data_sheet_energy_combined_4 <- data_sheet_energy %>% 
  select("company", "data_year", "fuel_4_type", "fuel_4_converted") %>% 
  rename(fuel_type = fuel_4_type) %>% 
  rename(value = fuel_4_converted)

#isolate fuel 5 values
data_sheet_energy_combined_5 <- data_sheet_energy %>% 
  select("company", "data_year", "fuel_5_type", "fuel_5_converted") %>% 
  rename(fuel_type = fuel_5_type) %>% 
  rename(value = fuel_5_converted)

```

########################################## SECTION 4 #######################################################
###################### Generate data subsets for TAB 2: Industry Trends ####################################
############################################################################################################

```{r}
# loop through all data years to create data frame for ggplot
# IMPORTANT: manually change years in for loop conditions for future use
for (year_count in 2007:2020) {
  # create a sub data frame that is filtered by data year and single data center scope
  data_of_transparency_SDC <- data_sheet_energy %>%
  filter(data_year == year_count, energy_reporting_scope == "Single Data Center") %>%
  select(company, data_year, energy_reporting_scope) 
  
  # we only need 1 row of a company given a data year/reporting scope so erase repeating values
  data_of_transparency_SDC <- distinct(data_of_transparency_SDC, .keep_all = TRUE)
  
  # create a sub data frame that is filtered by data year and multiple data centers scope
  data_of_transparency_MDC <- data_sheet_energy %>%
  filter(data_year == year_count, energy_reporting_scope == "Multiple Data Centers") %>%
  select(company, data_year, energy_reporting_scope)
  
  # we only need 1 row of a company given a data year/reporting scope so erase repeating values
  data_of_transparency_MDC <- distinct(data_of_transparency_MDC, .keep_all = TRUE)
  
  # create a sub data frame that is filtered by data year and company wide electricity scope
  data_of_transparency_TO <- data_sheet_energy %>%
  filter(data_year == year_count, energy_reporting_scope == "Total Operations") %>%
  select(company, data_year, energy_reporting_scope) 
  
  # we only need 1 row of a company given a data year/reporting scope so erase repeating values
  data_of_transparency_TO <- distinct(data_of_transparency_TO, .keep_all = TRUE)
  
  # create a sub data frame that is filtered by data year (***LOOK BACK AT THIS***)
  # IMPORTANT: leave energy reporting scope column blank for this transparency level!
  data_of_transparency_ND <- data_sheet_energy %>%
    filter(data_year == year_count, energy_reporting_scope == "") %>%
    select(company, data_year, energy_reporting_scope)

  # we only need 1 row of a company given a data year/reporting scope so erase repeating values
  data_of_transparency_ND <- distinct(data_of_transparency_ND, .keep_all = TRUE)
  
  # stack single data center/multiple data center data frames on top of each other
  data_of_transparency_L1 <- rbind(data_of_transparency_SDC, data_of_transparency_MDC)
  # since single/multiple data centers fall under same level, diminish to 1 row per company
  data_of_transparency_L1 <- distinct(data_of_transparency_L1, company, .keep_all = TRUE)
  
  # stack rest of the data frames together
  data_of_transparency_L1 <- rbind(data_of_transparency_L1, data_of_transparency_TO,
                                   data_of_transparency_ND)
  data_of_transparency_L1$value <- nrow(data_of_transparency_L1)
  
  # create the master data frame from the first index of the for loop
  # else: add the existing master data frame to the recently computed data frames
  if (year_count == 2007) {
    data_of_transparency <- rbind(data_of_transparency_L1)
  } else {
    data_of_transparency <- data_of_transparency %>% rbind(data_of_transparency_L1)
  }
  # sort graph in alphabetical order of company in order to make summation loop easier
  data_of_transparency <- data_of_transparency[order(data_of_transparency[,"data_year"]), ]
  #data_of_transparency <- distinct(data_of_transparency, company, .keep_all = TRUE)
}

# create new rows for companies that do not have L1/L2/L3 transparency in that given year
# in other words, create rows for level 4 companies (no report found)
data_of_transparency <- dummy_rows(data_of_transparency, 
                                   select_columns = c("company", "data_year"),
                                   dummy_value = 0)
data_of_transparency <- data_of_transparency[order(data_of_transparency[,"data_year"]), ]


# create another data frame that is filtered by company founding year
data_founding_year <- data_sheet_company %>% select(company_name, company_founding_year)
# drop all the excess rows that have NA data
data_founding_year <- na.omit(data_founding_year)

# NOW we have data for some companies that didn't even exist yet!
# take each company in data_founding year, compare with ALL rows in data_of_transparency,
# and if the founding year of the company is greater than the data year of the company,
# then keep track of that index in deleted_rows vector 
deleted_rows <- vector()
z = 1
for (i in 1:nrow(data_founding_year)) {
  for (j in 1:nrow(data_of_transparency)) {
    if (data_founding_year[i,1] == data_of_transparency[j,1]) {
      if (data_founding_year[i,2] > data_of_transparency[j,2]) {
        deleted_rows[z] <- j
        z <- z + 1
      }
    }
  }
}

# drop all rows that have company data prior to their founding year
data_of_transparency <- data_of_transparency[-c(deleted_rows), ]

data_of_transparency$unit <- 0
data_of_transparency <- data_of_transparency %>% select(data_year, energy_reporting_scope, value, unit)

# temporary garbage values 
year_dummy = 2006
report_dummy = "Hi"

# loop through all rows and rename energy reporting scopes
j = 0
for (i in 1:nrow(data_of_transparency)) {
  if (data_of_transparency[i,2] == "Single Data Center" || data_of_transparency[i,2] == "Multiple Data Centers") {
    data_of_transparency[i,2] = "Reported Data Center Energy Data"
  } else if (data_of_transparency[i,2] == "Total Operations") {
    data_of_transparency[i,2] = "Reported Company Wide Electricity Data"
  } else if (data_of_transparency[i,2] == "" || data_of_transparency[i,2] == "0") {
    data_of_transparency[i,2] = "No Reporting of Data"
  } else {
    data_of_transparency[i,2] = "Reported Company Wide Total Energy Data"
  }
  
  # sum the number rows based on company name and energy reporting scope
  # keeping track of the summation at the first instance of a distinct row
  if (data_of_transparency[i,1] == year_dummy && data_of_transparency[i,2] == report_dummy) {
    data_of_transparency[i-j,3] = data_of_transparency[i-j,3] + 1
    j = j + 1
  } else {
    year_dummy = data_of_transparency[i,1]
    report_dummy = data_of_transparency[i,2]
    data_of_transparency[i,3] = 1
    j = 1
  }
}

# drop the rest of the rows with value of 0
#data_of_transparency <- data_of_transparency[order(data_of_transparency[,""]), ]
data_of_transparency <- distinct(data_of_transparency, data_year, energy_reporting_scope, .keep_all = TRUE)

# find line graph values
year_dummy = 2006
j = 0
for (i in 1:nrow(data_of_transparency)) {
  if (data_of_transparency[i,1] == year_dummy) {
    data_of_transparency[i-j,4] = data_of_transparency[i-j,4] + data_of_transparency[i,3]
    j = j + 1
  } else {
    year_dummy = data_of_transparency[i,1]
    data_of_transparency[i,4] = data_of_transparency[i,3]
    j = 1
  }
}

# assign line graph values to each row with same year
year_dummy = 2006
for (i in 1:nrow(data_of_transparency)) {
  if (data_of_transparency[i,1] == year_dummy) {
    data_of_transparency[i,4] = data_of_transparency[i-1,4]
  } else {
    year_dummy = data_of_transparency[i,1]
  }
}

# create plot
p <- ggplot(data_of_transparency, aes(x=data_year)) + 
    geom_bar(aes(y=value, fill=energy_reporting_scope), 
             position=position_stack(reverse = TRUE), stat="identity") +
    geom_line(aes(y=unit), size=1.2, color="black") +
    ggtitle("Data Center Transparency") +
    theme_classic() +
    xlab("Year") +
    ylab("Percentage of Reporting Scope") +
    labs(fill = "Energy Reporting Scope")

ggplotly(p)
```

```{r}
# SPECIFIC ELECTRICITY USAGE BY YEAR GRAPH

# create a sub data frame that is filtered by data year and single data center scope
energy_use_SDC <- data_sheet_energy %>%
filter(data_year == 2020, energy_reporting_scope == "Single Data Center") %>%
select(company, data_year, energy_reporting_scope, level_of_ownership, electricity_prepped) 

# create a sub data frame that is filtered by data year and multiple data centers scope
energy_use_MDC <- data_sheet_energy %>%
filter(data_year == 2020, energy_reporting_scope == "Multiple Data Centers") %>%
select(company, data_year, energy_reporting_scope, level_of_ownership, electricity_prepped)

# create a sub data frame that is filtered by data year and company wide electricity scope
energy_use_L2 <- data_sheet_energy %>%
filter(data_year == 2020, energy_reporting_scope == "Total Operations") %>%
select(company, data_year, energy_reporting_scope, electricity_prepped) 

# stack single data center/multiple data center data frames on top of each other
energy_use_L1 <- rbind(energy_use_SDC, energy_use_MDC)
energy_use_L1 <- energy_use_L1[!(energy_use_L1$level_of_ownership == ""),]
energy_use_L1$electricity_value <- 0
energy_use_L1 <- energy_use_L1[order(energy_use_L1[,"level_of_ownership"]), ]

# combine single / multiple data center values
energy_use_L1$energy_reporting_scope <- "Data Centers"

company_temp <- "Fake Company"
ownership_temp <- "Fake Ownership"
j = 0
for (i in 1:nrow(energy_use_L1)) {
  # sum the number rows based on company name and ownership level
  # keeping track of the summation at the first instance of a distinct row
  if (energy_use_L1[i,1] == company_temp && energy_use_L1[i,4] == ownership_temp) {
    energy_use_L1[i-j,6] = energy_use_L1[i-j,6] + energy_use_L1[i,5]
    j = j + 1
  } else {
    company_temp = energy_use_L1[i,1]
    ownership_temp = energy_use_L1[i,4]
    energy_use_L1[i,6] = energy_use_L1[i,5]
    j = 1
  }
}

# drop all other rows now that sums are calculated
energy_use_L1 <- energy_use_L1[!(energy_use_L1$electricity_value == 0),]

# create plot for data center electricity usage
dc <- ggplot(energy_use_L1, aes(x=electricity_value)) + 
    geom_bar(aes(y=company, fill=level_of_ownership), 
             position=position_stack(reverse = TRUE), stat="identity") +
    ggtitle("Data Center Electricity Use by Year") +
    theme_classic() +
    scale_y_discrete(position = "right") +
    scale_x_continuous() +
    theme(legend.position = "left") +
    xlab("Electricity Value (KWh)") +
    ylab("Companies") +
    labs(fill = "Level Of Ownership") 
ggplotly(dc)


# L2 CALCULATIONS
energy_use_L2 <- na.omit(energy_use_L2)
energy_use_L2 <- energy_use_L2[order(energy_use_L2[,"company"]), ]
energy_use_L2$electricity_value <- 0

company_temp <- "Fake Company"
j = 0
for (i in 1:nrow(energy_use_L2)) {
  # sum the number rows based on company name and ownership level
  # keeping track of the summation at the first instance of a distinct row
  if (energy_use_L2[i,1] == company_temp) {
    energy_use_L2[i-j,5] = energy_use_L2[i-j,5] + energy_use_L2[i,4]
    j = j + 1
  } else {
    company_temp = energy_use_L2[i,1]
    energy_use_L2[i,5] = energy_use_L2[i,4]
    j = 1
  }
}

energy_use_L2 <- energy_use_L2[!(energy_use_L2$electricity_value == 0),]
energy_use_L2 <- energy_use_L2[!(energy_use_L2$company == "China Telecom"),]
energy_use_L2 <- energy_use_L2[!(energy_use_L2$company == "Apple"),]

#ggplot(energy_use_L2, aes(area = electricity_value, fill = company, label = company)) +
  #geom_treemap() + geom_treemap_text()

# create plot for company wide electricity usage
cw <- ggplot(energy_use_L2, aes(x=electricity_value)) + 
    geom_bar(aes(y=company, fill=electricity_value), 
             position="stack", stat="identity") +
    ggtitle("Company Wide Electricity Use by Year") +
    theme_classic() +
    xlab("Electricity Value (KWh)") +
    ylab("Companies") 

ggplotly(cw)

```

```{r}

#start with this graph's aesthetics
ggplot(graph_by_industry_total, aes(fill=company, y=value, x=data_year)) + 
    geom_bar(stat="identity") +
    theme(legend.position="none")

```

########################################## SECTION 5 #######################################################
###################### Generate data subsets for TAB 3: Company Analysis ###################################
############################################################################################################

``` {r}
  
###############################################################
################# Export data sheet ###########################
## Contents: Raw values form Input-Company Profiles############
###############################################################

write.csv(data_sheet_company, here("data", "data_sheet_company.csv"))

##################################################################################
########################### Export data sheet ####################################
#### Contents: Fuel use (electricity, fuel 1, fuel 2...) by company, by year #####
##################################################################################

#electricity and all fuel values on top of each other, drop columns with NA (filter by Apple for example plotting)
graph_by_fuel_type <- 
  rbind(data_sheet_energy_electricity, data_sheet_energy_combined_1, #stack converted electricity, fuel values sheets on top of each other
        data_sheet_energy_combined_2, data_sheet_energy_combined_3,
        data_sheet_energy_combined_4, data_sheet_energy_combined_5) %>%
  drop_na() #%>% drop na values from spreadsheet
  #filter(company == "Spark") %>% #filter by specific company
  #arrange(desc(data_year)) #sort data_year by year for easier viewing

write.csv(graph_by_fuel_type, here("data", "by_fuel_type_data.csv"))

##############################################################################
########################## Export pre-processed dataset ######################
## Contents: Fuel use (electricity, fuel 1, fuel 2...) by company, by year ###
##############################################################################

graph_by_industry_total <- data_sheet_energy %>% 
  mutate_at(vars(electricity_converted, fuel_1_converted, #replace na values with 0
           fuel_2_converted, fuel_3_converted, fuel_4_converted, 
           fuel_5_converted), ~replace_na(., 0)) %>%
  rowwise() %>% 
  mutate(total_energy_use = sum(electricity_converted, fuel_1_converted, #create new column, total energy use, sum electricity and fuel values across to calculate total energy
           fuel_2_converted, fuel_3_converted, fuel_4_converted, 
           fuel_5_converted)) %>% 
  select("company", "data_year", "energy_reporting_scope", "total_energy_use") %>%
  mutate(energy_reporting_scope = case_when(
    energy_reporting_scope %in% c("Multiple Data Centers", "Single Data Center") ~ "Data Centers",
    energy_reporting_scope %in% "Total Operations"                               ~ "Total Company Energy Use")) %>% 
  unite('company', c(company,energy_reporting_scope), sep = " | ") %>% 
  group_by(company, data_year) %>% 
  summarize(value = sum(total_energy_use)) %>% 
  filter(company != 'Fujitsu | Total Company Energy Use', company != 'American Express | Total Company Energy Use') %>%  #need to review these numbers, were they recorded wrong? are they just really large? or are the sums being calculated wrong? %>% 
  drop_na()

write.csv(graph_by_industry_total, here("data", "aggregate_data.csv"))

##############################################################################
########################## Export pre-processed dataset ######################
## Contents: Fuel use (electricity, fuel 1, fuel 2...) by company, by year ###
##############################################################################

graph_by_data_center <- data_sheet_energy %>% 
  mutate_at(vars(electricity_converted, fuel_1_converted, #replace na values with 0
           fuel_2_converted, fuel_3_converted, fuel_4_converted, 
           fuel_5_converted), ~replace_na(., 0)) %>%
  rowwise() %>% 
  mutate(total_energy_use = sum(electricity_converted, fuel_1_converted, #create new column, total energy use, sum electricity and fuel values across to calculate total energy
           fuel_2_converted, fuel_3_converted, fuel_4_converted, 
           fuel_5_converted)) %>% 
  relocate(total_energy_use, .after = notes) %>% #move total_energy_use column after notes column for easier viewing
  unite('scope_display_label', energy_reporting_scope:display_label, sep = " | ") %>% #merge reporting scope and display label to create label for each data center
  select("company", "data_year", "scope_display_label", "total_energy_use") %>% #select only company, data_year, scope_display_label, total_energy_use
  mutate_at(vars(total_energy_use), as.numeric) %>% #set total energy use column as numeric to display
                    filter(company == "Apple") #filter by only Apple
```

